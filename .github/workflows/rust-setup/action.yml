name: "Rust setup"
description: "Runs base setup for Database and dependencies"

runs:
  using: composite
  steps:
    - name: Check environment variables
      run: env
      shell: bash
    - name: Cache dependencies
      id: cache-dependencies
      uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
#    - name: Install stable toolchain
#      uses: actions-rs/toolchain@v1
#      with:
#        profile: minimal
#        toolchain: stable
#        override: true

    - name: Cache sqlx-cli
      uses: actions/cache@v2
      id: cache-sqlx
      with:
        path: |
          ~/.cargo/bin/sqlx
        key: ${{ runner.os }}-sqlx-${{ env.SQLX_VERSION }}

    - name: Install sqlx-cli 
      uses: actions-rs/cargo@v1
      if: steps.cache-sqlx.outputs.cache-hit == false
      with:
        command: install 
        args: >
          sqlx-cli
          --force
          --version=${{ env.SQLX_VERSION }}
          --features ${{ env.SQLX_FEATURES }}
          --no-default-features
          --locked
    - name: Migrate database
      run: |
        sudo apt-get install libpq-dev -y
        SKIP_DOCKER=true ./scripts/init_db.sh
      shell: bash